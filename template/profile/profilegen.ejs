<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile_General</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="/../profile/css/profile_gen.css">
    <link rel="stylesheet" href="/../profile/css/Template_HF.css">
</head>

<body>
    <div class="content-wrapper">
        <header>
            <a href="/" style="text-decoration: none; color: inherit;">
                <h2>SDhire</h2>
            </a>
            <div class="profile_container">
                <div class="buttom_header">
                    <button type="button" class="profile_button" onclick="toggleDropdown()">
                        <div class="photo_profile">
                            <% if(userdata.profile_image){ %>
                                <img src="/imageForTest/<%= userdata.profile_image %>"
                                    alt="<%= userdata.profile_image%>">
                                <% } else{%>
                                    <img src="https://ui-avatars.com/api/?name=<%= userdata.username || 'User' %>"
                                        alt="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå">
                                    <% }%>
                        </div>
                        <span>Profile</span>
                    </button>
                </div>

                <div class="data_box" id="myDropdown">
                    <div class="user_infor">
                        <% if(userdata.profile_image){ %>
                            <img src="/imageForTest/<%= userdata.profile_image %>" alt="<%= userdata.profile_image%>">
                            <% } else{%>
                                <img src="https://ui-avatars.com/api/?name=<%= userdata.username || 'User' %>"
                                    alt="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå">
                                <% }%>
                                    <div class="user_name">
                                        <h1>
                                            <%=userdata.username%>
                                        </h1>
                                        <span class="status-dot"></span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ : <%= userdata.roles %>
                                    </div>
                    </div>

                    <div class="button_VO">
                        <%if(userdata.ID!=profileUser.ID){%>
                            <%if(userdata.roles=="student"){%>
                                <a href="/home/profilestudent/<%=userdata.ID%>">
                                    <button class="b_view">‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
                                </a>
                                <%}else if(userdata.roles=="general" ){%>
                                    <a href="/home/profilegeneral/<%=userdata.ID%>">
                                        <button class="b_view">‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
                                    </a>
                                    <%}%>
                                        <%}%>
                                            <a>
                                                <form action="/logout" method="post">
                                                    <button class="b_logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                                                </form>
                                            </a>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">
            <div class="page-wrapper">
                <div class="profile-header">
                    <div class="avatar-wrapper">
                        <% if(userdata.ID==profileUser.ID){ %>
                            <img src="/imageForTest/<%= profileUser.profile_image %>"
                                alt="<%= profileUser.profile_image%>" class="avatar-img" id="profile_">
                            <% } else{%>
                                <img src="https://ui-avatars.com/api/?name=<%= profileUser.username || 'User' %>"
                                    alt="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå" class="avatar-img" id="profile_">
                                <% }%>
                                    <%if(userdata.general)%>
                                        <input type="file" accept="image/*" id="avatar_upload"
                                            onchange="edit_profile_gen(this)" style="display: none;">
                                        <%if(userdata.ID==profileUser.ID){%>
                                            <button class="edit-avatar-btn"
                                                onclick="document.getElementById('avatar_upload').click()">‚úé</button>
                                            <%}%>
                    </div>

                    <div class="header-info">
                        <div class="name-rating-row">
                            <h1 id="user-name">
                                <%=profileUser.username%>
                            </h1>
                        </div>
                        <p class="status-badge">
                            <span class="status-dot"></span> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ : <%= profileUser.roles %>
                        </p>
                    </div>
                </div>

                <div class="profile-content-grid">

                    <aside class="sidebar-info">
                        <div class="info-card">
                            <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠</h3>
                            <div class="info-item">
                                <span class="icon">üíº</span>
                                <div class="text">
                                    <p>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</p>
                                    <strong>
                                        <%= jobCount %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                    </strong>
                                </div>
                            </div>


                        </div>


                        <div class="info-card" style="margin-top: 20px; padding: 20px;">
                            <div class="section-header">
                                <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h3>
                                <% if(userdata.ID==profileUser.ID){ %>
                                    <button onclick="toggleEditGen()" id="edit-btn-gen" class="btn-small">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                    <% } %>
                            </div>

                            <ul class="contact-list">
                                <li>
                                    <span class="icon">üìß</span>
                                    <span class="contact-value" id="val-email">
                                        <%= profileUser.email || "-" %>
                                    </span>
                                </li>
                                <li>
                                    <span class="icon">üìû</span>
                                    <span class="contact-value" id="val-phone">
                                        <%= profileUser.userPhoneNumber || "-" %>
                                    </span>
                                </li>
                                <li>
                                    <span class="icon" style="color: #06c755;">L</span>
                                    <span class="contact-value" id="val-line">
                                        <%= (profileUser.line && profileUser.line !="null" ) ? profileUser.line : "-" %>
                                    </span>
                                </li>
                                <li>
                                    <span class="icon" style="color: #1877f2;">F</span>
                                    <span class="contact-value" id="val-facebook">
                                        <%= (profileUser.facebook && profileUser.facebook !="null" ) ?
                                            profileUser.facebook : "-" %>
                                    </span>
                                </li>
                                <li>
                                    <span class="icon" style="color: #E1306C;">Ig</span>
                                    <span class="contact-value" id="val-ig">
                                        <%= (profileUser.instagram && profileUser.instagram !="null" ) ?
                                            profileUser.instagram : "-" %>
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </aside>



                    <section class="main-details">
                        <div class="detail-box">
                            <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏á‡∏≤‡∏ô</h2>
                            <div class="job-list">
                                <% if (jobs && jobs.length> 0) { %>
                                    <% jobs.forEach(job=> { %>
                                        <article class="job-item">
                                            <a href="/home/viewGeneralPost/<%=job.order_ID%>"
                                                style="text-decoration: none; color: inherit; flex-grow: 1;">
                                                <div class="job-info">
                                                    <h1 class="job-link">
                                                        <%= job.title %>
                                                    </h1>
                                                    <p class="job-description-text">
                                                        <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:</strong>
                                                        <%= job.orderType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' %> <br>
                                                            <%= job.des_cript || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' %>
                                                    </p>
                                                    <div class="job-meta-group">
                                                        <p class="job-meta">üí∞ ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: <%= job.budjet %> ‡∏ö‡∏≤‡∏ó</p>
                                                        <p class="job-meta">üìÖ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: <%= new
                                                                Date(job.post_date).toLocaleDateString('th-TH') %>
                                                        </p>
                                                        <% if(job.deadline) { %>
                                                            <p class="job-meta">‚è∞ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: <%= new
                                                                    Date(job.deadline).toLocaleDateString('th-TH') %>
                                                            </p>
                                                            <% } %>
                                                    </div>
                                                </div>
                                            </a>
                                            <div class="job-status-wrapper">
                                                <% if (job.status==='closed' ) { %>
                                                    <span class="status-tag closed"
                                                        style="background-color: #EF4444; color: white;">‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>
                                                    <% } else { %>
                                                        <span class="status-tag active">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
                                                        <% if(userdata.ID==profileUser.ID) { %>
                                                            <button class="btn-small date-badge"
                                                                style="background-color: #EF4444; color: white; border: none; cursor: pointer; margin-top: 5px;"
                                                                onclick="closeJob('<%= job.order_ID %>')">
                                                                ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                                                            </button>
                                                            <% } %>
                                                                <% } %>
                                            </div>
                                        </article>
                                        <% }) %>
                                            <% } else { %>
                                                <p style="text-align: center; color: #94a3b8;">
                                                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏á‡∏≤‡∏ô</p>
                                                <% } %>
                            </div>
                        </div>


                    </section>

                </div>
            </div>
        </main>
    </div>
    <footer>
        <div class="footer-contact">
            <p>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</p>
            <p>sdhire67@gmail.com</p>
        </div>
        <div class="footer-bottom">
            <p>¬© 2025 SDhire, All right reserved</p>
        </div>
    </footer>
    <!--cookie-->
    <div id="cookie-banner"
        style="display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; padding: 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 9999;">
        <div
            style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
            <p style="margin: 0; color: #333;">‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ<a href="/policy"
                    style="color: #9b59b6;">‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a></p>
            <div>
                <button onclick="acceptCookies()"
                    style="background: #9b59b6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö</button>
            </div>
        </div>
    </div>
    <script src="../cookie.js"></script>
    <script src="/../profilejs/script.js"></script>
    <script src="/../profilejs/post_work.js"></script>
    <script src="/../profilejs/swith_PR.js"></script>

    <script>
        // Close Job Function
        async function closeJob(orderId) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£?',
                text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch('/general/closeJob', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ order_id: orderId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        await Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        window.location.reload();
                    } else {
                        Swal.fire('Error', data.message || 'Failed to close job', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Something went wrong', 'error');
                }
            }
        }

        let isEditingContactGen = false;
        async function toggleEditGen() {
            const btn = document.getElementById('edit-btn-gen');
            const fields = ['val-phone', 'val-line', 'val-facebook', 'val-ig'];

            if (!isEditingContactGen) {
                // Edit Mode
                fields.forEach(id => {
                    const span = document.getElementById(id);
                    if (span) {
                        const currentValue = span.innerText.trim();
                        const safeValue = currentValue === '-' ? '' : currentValue;
                        span.innerHTML = `<input type="text" id="input-${id}" value="${safeValue}" style="width:100%; box-sizing: border-box; padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">`;
                    }
                });
                btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
                btn.classList.add('btn-save');
                isEditingContactGen = true;
            } else {
                // Save Mode
                const phoneInput = document.getElementById("input-val-phone");
                const lineInput = document.getElementById("input-val-line");
                const fbInput = document.getElementById("input-val-facebook");
                const igInput = document.getElementById("input-val-ig");

                const payload = {
                    phone: phoneInput ? phoneInput.value.trim() : "",
                    line: lineInput ? lineInput.value.trim() : "",
                    facebook: fbInput ? fbInput.value.trim() : "",
                    ig: igInput ? igInput.value.trim() : ""
                };

                try {
                    const response = await fetch("/general/update", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                            showConfirmButton: false,
                            timer: 1500
                        });

                        // Revert to text
                        fields.forEach(id => {
                            const input = document.getElementById(`input-${id}`);
                            const span = document.getElementById(id);
                            if (input && span) {
                                const newVal = input.value;
                                span.innerHTML = newVal ? newVal : "-";
                            }
                        });
                        btn.innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
                        btn.classList.remove('btn-save');
                        isEditingContactGen = false;
                    } else {
                        Swal.fire({ icon: 'error', title: 'Error', text: result.message || 'Update failed' });
                    }
                } catch (err) {
                    console.error(err);
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Connection failed' });
                }
            }
        }
    </script>
</body>

</html>